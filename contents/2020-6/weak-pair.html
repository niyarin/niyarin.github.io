<html><head><meta name="twitter:card" content="summary"/><meta name="og:title" content="Weakpair memo"/><meta name="og:description" content="Weak pairについてのまとめ"/><meta name="og:image" content="https://niyarin.github.io/contents_resources/scheme_niyarin.png"/><title>Niyarin's blog</title><meta charaset="utf-8"/><link rel="stylesheet" type="text/css" href="../../resources/style.css"/></head><body><div class="page-wrapper"><div class="sidemenu-wrapper"><div class="sidemenu"><div class="sidemenu-box"><h4>#Author</h4><a href="../../contents/about_me.html">Niyarin</a><br></br>SchemerでClojurian.</div><div class="sidemenu-box"><span class="tag"><h4>#Tags</h4><div><div><a href="../../tags/Scheme.html"><span class="tagbox">Scheme</span></a><br></br></div><div><a href="../../tags/Clojure.html"><span class="tagbox">Clojure</span></a><br></br></div></div></span></div><div class="sidemenu-box"><h4>#Recent entries</h4><div><div style="margin-bottom:10px;border-bottom:1px solid #EEEEEE;">2018-12-14:<a href="../../contents/2018-12/advent-calender2018.html">実装が大変なschemeの機能の紹介</a></div><div style="margin-bottom:10px;border-bottom:1px solid #EEEEEE;">2019-12-04:<a href="../../contents/2019-12/chez-callcc.html">Chezのcall/cc論文の紹介...</a></div><div style="margin-bottom:10px;border-bottom:1px solid #EEEEEE;">2019-12-08:<a href="../../contents/2019-12/my-sample-play-cljc.html">Play-cljcを使おう</a></div><div style="margin-bottom:10px;border-bottom:1px solid #EEEEEE;">2019-12-22:<a href="../../contents/2019-12/my-scm-plan.html">あとで実装するありがちなSchem...</a></div><div style="margin-bottom:10px;border-bottom:1px solid #EEEEEE;">2020-06-19:<a href="../../contents/2020-6/weak-pair.html">Weak-pair memo (S...</a></div></div></div></div></div><div class="main"><div class="main-contents"><header class="main-contents-title"><a href="../../index.html">Niyarin's blog</a></header><div class="inner-contents"><h1>Weak-pair memo (Scheme)</h1><span>Tags:<a href="../../tags/Scheme.html"><span class="tagbox">Scheme</span></a></span><div class="time-box">2020-06-19</div><br/><br/><div><div>weak-pairというデータ構造がある。<br/>これはcar部が弱参照でcdr部が強参照なペアで、SchemeだとMit/GNU Schemeで処理系依存の機能として提供されていたりする。<a href="https://www.gnu.org/software/mit-scheme/documentation/mit-scheme-ref/Weak-Pairs.html">→ 10.7.1 Weak Pairs</a><br/>標準の仕様としては、より高度なデータ構造Ephemeronが R7RS large/SRFI-124で定義されている。<br/>図はこんな感じ。弱参照を<span style="color:#6C8EBF">青</span>、強参照を<span style="color:#B85450">赤</span>としている。<br/><img src="../../contents_resources/202006/weak-pair.png" width="200px" style="border:solid 1px;margin:10px;"/><br/><h4>通常のconsセルと違う点(Mit/GNU Schemeの例)</h4><ul><li>carが回収済み(broken)の時、weak-car(weak-pair用のcar)すると#fが帰ってくる。</li><li>carが回収済み(broken)かの述語が提供されている。</li></ul></div><h2>弱リスト</h2>通常のconsで作ったリストのようにWeak Pairsでリストを構築するとWeak listができる。<br/><img src="../../contents_resources/202006/weak-list.png" width="400px" style="border:solid 1px;margin:10px;"/><br/>ただ、carが回収済みなセルを消す実装をしたい場合、Schemeにはfinalizeのような機構があまり提供されないので少し面倒かもしれない。<br/>cdr時に生存判定して、消していくとか?<h2>弱ベクタ</h2>car部を弱参照のboxとしても使えるので、それをそのままvectorの各要素に入れればweak-vectorが作れる。<br/><img src="../../contents_resources/202006/weak-vector.png" width="320px" style="border:solid 1px;margin:10px;"/><h2>弱連想リスト</h2>弱連想リストは、<ul><li>keyが弱参照、valが強参照</li><li>keyが強参照、valが弱参照</li><li>keyが弱参照、valが弱参照</li></ul>のパターンがある。<br/>下の図は、keyが弱参照、valが強参照の弱連想listの例で、通常のSchemeの連想リストと違う構造になっている。図が上下しているからわかりにくいが、実質奇数番目が弱参照で偶数番目が強参照のただの平らなリストで表現している。偶数番目もweak-pairを使えば両方弱参照の連想リストが作れるし、偶数奇数の強弱を入れ替えればkeyが強参照、valが弱参照のものも作れる。<br/><img src="../../contents_resources/202006/weak-alist.png" width="400px" style="border:solid 1px;margin:10px;"/><br/>keyが弱参照,valが弱参照のものは通常のSchemeの連想リストと同じ構造でweak-pairを用いて構築してもたしかに性質は変わらない。ただ、Ephemeronに置き換えた時に少し違う挙動になる。Ephemeronはcdrのオブジェクトからcarのオブジェクトに強参照していても、他に強参照がなければ回収できるという特徴をもつ。つまり、通常のSchemeと同じ構造のEphemeronを使った連想リストは、他の部分から強参照があっても回収できないが、上の図の構造で実装するとそれが可能になるという違いがでてくる。</div></div></div></div></div></body></html>